# üåç GeoIP Lookup to CSV Tool

This Python script runs the built-in `geoip_lookup` command on an **F5 BIG-IP TMOS device** and outputs the results (IP ‚Üí Country) into a CSV file.  
It is designed for **BIG-IP TMOS 17.1.x and above** where Python 3 is available. üêç

---

## üöÄ Features
- Runs `geoip_lookup` in **parallel** for speed (uses Python threads).
    - For 10,000 IPs the script completes in ~20 seconds. 
- Extracts the **country code** for each IP.
- CSV header includes the **GeoIP DB version** (e.g., `country_20250826`). ‚úÖ
- Handles errors gracefully ‚Üí outputs `UNKNOWN` if lookup fails or times out.

---

## ‚úÖ Prerequisites
- Must be run **on the BIG-IP device itself** (the `geoip_lookup` tool is provided by TMOS).
- Python 3 available on the system (TMOS 17.1+ includes Python 3).
- Sufficient user privileges to run `geoip_lookup` and to write the chosen output path.

---

## üñ•Ô∏è Where to Run
- This script must be run **directly on a BIG-IP TMOS device** (version **17.1.x or later**).  
- It assumes the system `geoip_lookup` command is installed (default on TMOS).  
- Place the script in `/shared/tmp/` or another writable directory.

---

## ‚öôÔ∏è Installation / Copying to BIG-IP
From your workstation, copy the script to the BIG-IP (adjust host and path as needed):

```bash
scp bulk_geo_lookup.py root@<bigip-mgmt-ip>:/shared/tmp/bulk_geo_lookup.py
```

On the BIG-IP, make it executable (optional):

```bash
chmod +x /shared/tmp/bulk_geo_lookup.py
```

You can also run it directly with `python3` without making it executable.

---

## ‚öôÔ∏è Usage

Create a text file with one IP address per line:

ips.txt
```
1.1.1.1
8.8.8.8
```

Run the script:

```bash
# Write CSV to a file
python3 bulk_geo_lookup.py -i ips.txt -o myGeoResults.csv
```

### Options
- `-i, --input` (required) ‚Äî Input file containing one IP per line.
- `-o, --output` ‚Äî Output CSV file path. Use `-` to write to stdout. Default: `-`.
- `--cmd` ‚Äî geoip command to run (default: `geoip_lookup`).
- `-c, --concurrency` ‚Äî Number of parallel workers (default: ~5x CPU cores). This is usually optimal for performance.
- `--timeout` ‚Äî Per-IP command timeout in seconds (default: 3.0).


## üìÑ Output CSV format
- Header: `ip,country_<DBVERSION>` where `<DBVERSION>` is the 8-digit DB date if detected or `UNKNOWN`.
- Each subsequent row: `IP,COUNTRY_CODE` (COUNTRY_CODE is `UNKNOWN` on error/timeout).

Example:
```
ip,country_20250826
1.1.1.1,AU
8.8.8.8,US
```

---

## üß∞ Notes & Troubleshooting
- If you get `UNKNOWN` for all lookups, verify `geoip_lookup` works on the BIG-IP shell with `geoip_lookup 8.8.8.8` and returns a valid country code.
- For 10,000 IPs the script completes in about 25 seconds. Your mileage may vary.
- I found the default `--concurrency` of 5 to have overall best performance. 

## Disclaimer
- This script and readme generated by GPT-4 and tested to be functional. 


